# 🏙️ GA City - 遺伝的アルゴリズムによる都市育成ゲーム

![Julia](https://img.shields.io/badge/-Julia-9558B2?style=for-the-badge&logo=julia&logoColor=white)

遺伝的アルゴリズムを使って最適な都市レイアウトを進化させるJuliaプログラムです。道路ネットワークの100%連結性を保証しながら、住みやすい都市を自動生成します。

## 🎮 概要

GA Cityは、100×100グリッド上で理想的な都市を自動生成するシミュレーションプログラムです。遺伝的アルゴリズム（GA）を用いて、住宅、職場、サービス施設、公園、道路のバランスが取れた最適な都市配置を探索します。特に、道路ネットワークの完全な連結性を保証するアルゴリズムを実装しています。

## ✨ 特徴

- **100%道路連結性保証**: Union-Find アルゴリズムによる道路ネットワークの完全連結
- **遺伝的アルゴリズムによる最適化**: Evolutionary.jl パッケージを使用した進化的最適化
- **100×100グリッド**: 10,000セルの大規模都市シミュレーション
- **5種類の施設タイプ（絵文字表示）**: 
  - 🌳 公園（緑地）
  - 🟫 道路
  - 🏠 住宅
  - 🏢 職場（オフィス）
  - 🏪 サービス施設（商店など）
- **多目的都市評価システム**: 
  - 住宅と職場の距離（通勤時間）
  - 住宅とサービス施設の距離（利便性）
  - 公園の比率（環境の良さ）
  - 道路接続性（施設が道路に接続）
  - 道路ネットワーク連結性（すべての道路が連結）
- **モジュール化されたコード構造**: 機能別に整理された保守性の高い設計
- **包括的なテストスイート**: 41個のユニットテストによる品質保証

## 📋 必要環境

- Julia 1.6以上
- 必要パッケージ:
  - Random
  - Statistics
  - Evolutionary

## 🚀 インストール

```bash
# リポジトリをクローン
git clone https://github.com/Tdual/ga_city.git
cd ga_city

# Juliaパッケージマネージャーで必要なパッケージをインストール
julia -e 'using Pkg; Pkg.add(["Random", "Statistics", "Evolutionary"])'
```

## 💻 使い方

### 基本的な実行

```bash
julia src/ga_city.jl
```

実行すると対話型メニューが表示され、以下の設定が可能です：

1. **プリセット選択**
   - バランス型（デフォルト）
   - 職住近接重視
   - 緑化重視  
   - サービス重視
   - カスタム設定

2. **進化パラメータ**
   - 個体数（デフォルト: 80）
   - 世代数（デフォルト: 100）
   - 進行ログ表示

3. **遺伝的演算子**
   - 選択: susinv | tournament
   - 交叉: DC | uniformbin
   - 変異: PLM | gaussian

### テストの実行

```bash
# 基本テストスイート
julia tests/test_ga_city.jl

# 詳細なテスト出力
julia tests/run_tests_verbose.jl
```

### Juliaの対話環境から実行

```julia
include("src/ga_city.jl")
main()
```

### プログラム的なカスタマイズ

```julia
include("src/modules.jl")

# GameConfigを直接編集
CFG.w_commute = -1.5      # 通勤距離の重要度を上げる
CFG.w_park = 1.2           # 公園の重要度を上げる
CFG.generations = 200      # 世代数を増やす

# 進化を実行
best_x, best_f = run_ga()

# 最適な都市を表示
println("Best fitness: ", round(best_f, digits=3))
print_city_sample(best_x, 30)
```

## 🏗️ システムの仕組み

### 適応度関数

都市の「良さ」は以下の要素で評価されます：

1. **通勤距離**: 住宅から職場への平均マンハッタン距離（短いほど高評価）
2. **利便性**: 住宅からサービス施設への平均距離（短いほど高評価）
3. **環境**: 公園の比率（多いほど高評価）
4. **道路接続性**: 施設が道路に隣接しているか
5. **道路ネットワーク**: すべての道路が1つに連結されているか

各要素の重みは`GameConfig`構造体で調整可能：
- `w_commute`: 通勤距離の重み（負値、デフォルト: -1.0）
- `w_service`: サービス距離の重み（負値、デフォルト: -0.6）
- `w_park`: 公園比率の重み（正値、デフォルト: 0.8）
- `w_road_connect`: 道路非接続ペナルティ（負値、デフォルト: -10.0）
- `w_road_network`: 道路ネットワーク連結ボーナス（正値、デフォルト: 100.0）
- `penalty_disconnect`: 道路の非連結ペナルティ（負値、デフォルト: -1000.0）

### 遺伝的アルゴリズムの設定

- **選択**: Stochastic Universal Sampling with Inversion (susinv)
- **交叉**: Discrete Crossover (DC)
- **変異**: Polynomial Mutation (PLM)
- **制約**: 各セルは0〜4の値を取る（BoxConstraints）

### 道路連結性の保証

1. **初期化**: BFSアルゴリズムによる連結道路網の生成
2. **連結性チェック**: Union-Find アルゴリズムによる高速な連結成分検出
3. **修復機能**: 分断された道路を自動的に接続

## 📊 出力例

```
=== Genetic City (道路接続性版, 100×100グリッド) ===
Best fitness: -10214.74
道路連結状態: ✅ 100%連結
道路総数: 4211

Best city layout:
都市の一部を表示 (30×30, 位置: [35:64, 35:64])
🌳=公園 🟫=道路 🏠=住宅 🏢=職場 🏪=サービス
────────────────────────────────────────
🟫🟫🏠🏢🟫🟫🟫🟫🟫🟫🟫🟫🏠🌳🌳🏠🟫🏢🌳🏪
🏪🏪🌳🟫🟫🌳🏢🏢🏠🏢🟫🟫🟫🏠🌳🏢🟫🟫🏢🏠
🟫🏢🏢🌳🏠🌳🏠🏢🌳🏢🟫🌳🟫🏢🌳🏠🌳🏢🏠🟫
🟫🏠🏢🏪🌳🏠🏠🏢🟫🟫🟫🌳🟫🏠🏠🏢🌳🏢🏢🟫
```

## 🎮 プリセット設定

### バランス型（デフォルト）
- 通勤、サービス、公園のバランスが取れた都市
- 設定値: 通勤-1.0, サービス-0.6, 公園+0.8, 道路接続-10.0, 連結+100.0

### 職住近接重視
- 通勤時間を最小化する都市設計
- 設定値: 通勤-1.6, サービス-0.4, 公園+0.4, 道路接続-10.0, 連結+100.0

### 緑化重視
- 公園や緑地を多く配置した環境都市
- 設定値: 通勤-0.6, サービス-0.4, 公園+1.4, 道路接続-8.0, 連結+80.0

### サービス重視
- 商業施設へのアクセスを重視した都市
- 設定値: 通勤-0.8, サービス-1.4, 公園+0.4, 道路接続-10.0, 連結+100.0

## 📁 ディレクトリ構造

```
ga_city/
├── README.md                     # このファイル
├── LICENSE                       # MITライセンス
├── .gitignore                    # Git除外設定
│
├── src/                          # ソースコード
│   ├── ga_city.jl               # メインプログラム
│   ├── modules.jl               # モジュール読み込み管理
│   ├── config.jl                # 設定とプリセット定義
│   ├── road_connectivity.jl     # 道路連結性アルゴリズム
│   ├── fitness.jl               # 適応度関数
│   ├── evolution.jl             # 遺伝的アルゴリズム実装
│   ├── display.jl               # 表示・出力関連
│   └── ui.jl                    # ユーザーインターフェース
│
└── tests/                        # テストコード
    ├── test_ga_city.jl          # メインテストスイート
    └── run_tests_verbose.jl     # 詳細テスト実行
```

### 各モジュールの説明

- **ga_city.jl**: メインエントリポイント、プログラム全体の制御
- **modules.jl**: 他のモジュールの読み込みを一元管理
- **config.jl**: グリッドサイズ、重み、プリセットなどの設定
- **road_connectivity.jl**: Union-Find、BFS、道路修復アルゴリズム
- **fitness.jl**: 都市評価のための適応度関数
- **evolution.jl**: Evolutionary.jlを使用したGA実装
- **display.jl**: 絵文字による都市表示機能
- **ui.jl**: 対話型メニューシステム

## 🎯 今後の拡張アイデア

- グリッドサイズの動的変更機能
- 新しい施設タイプの追加（病院、学校、駅など）
- 地形制約の追加（川、山、海岸線など）
- インタラクティブな可視化（Web UI）
- 複数目的最適化の実装（パレート最適解）
- 時系列での都市成長シミュレーション
- 交通流シミュレーションの追加

## 📝 ライセンス

MITライセンス

## 👤 作者

tdual

## 🤝 貢献

イシューやプルリクエストは歓迎します！

1. Fork the Project
2. Create your Feature Branch (`git checkout -b feature/AmazingFeature`)
3. Commit your Changes (`git commit -m 'Add some AmazingFeature'`)
4. Push to the Branch (`git push origin feature/AmazingFeature`)
5. Open a Pull Request